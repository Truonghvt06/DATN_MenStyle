<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√¥ng tin ng∆∞·ªùi d√πng</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    img { max-width: 100px; }
  </style>
</head>
<body>
  <h2>Th√¥ng tin ng∆∞·ªùi d√πng</h2>
  <div class="d-flex">
    <div class="me-3">
      <img src="<%= user.avatar || '/default-avatar.png' %>" alt="Avatar" style="max-width: 100px;">
    </div>
    <div>
      <p><strong>H·ªç t√™n:</strong> <%= user.name || 'N/A' %></p>
      <p><strong>Email:</strong> <%= user.email || 'N/A' %></p>
      <p><strong>SƒêT:</strong> <%= user.phone || 'N/A' %></p>
      <p><strong>Gi·ªõi t√≠nh:</strong> <%= user.gender || 'N/A' %></p>
      <p><strong>Ng√†y sinh:</strong> <%= user.date_of_birth ? new Date(user.date_of_birth).toLocaleDateString('vi-VN') : 'N/A' %></p>
    </div>
  </div>

  <h2>üõí Gi·ªè h√†ng</h2>
  <% if (user.cart && user.cart.length > 0) { %>
    <table class="table">
      <thead>
        <tr>
          <th>·∫¢nh</th>
          <th>T√™n s·∫£n ph·∫©m</th>
          <th>Size / M√†u</th>
          <th>S·ªë l∆∞·ª£ng</th>
        </tr>
      </thead>
      <tbody>
        <% user.cart.forEach((item) => { %>
          <% const product = item.productId; %>
          <% const variant = product?.variants?.[item.variantIndex] || {}; %>
          <tr>
            <td>
              <% if (variant.image || product?.image) { %>
                <img src="<%= variant.image || product.image %>" alt="<%= product.name %>" style="max-width: 100px;">
              <% } else { %>
                Kh√¥ng c√≥ ·∫£nh
              <% } %>
            </td>
            <td><%= product?.name || 'N/A' %></td>
            <td><%= variant.size || 'N/A' %> / <%= variant.color || 'N/A' %></td>
            <td><%= item.quantity || 1 %></td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  <% } else { %> 
    <p>Ch∆∞a c√≥ s·∫£n ph·∫©m trong gi·ªè h√†ng.</p>
  <% } %>

  <h2>‚ù§Ô∏è S·∫£n ph·∫©m y√™u th√≠ch</h2>
  <% if (user.favorites && user.favorites.length > 0) { %>
    <table class="table">
      <thead>
        <tr>
          <th>·∫¢nh</th>
          <th>T√™n s·∫£n ph·∫©m</th>
          <th>Size / M√†u</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <% user.favorites.forEach((fav) => { %>
          <% const product = fav.productId; %>
          <% const variant = product?.variants?.[fav.variantIndex] || {}; %>
          <tr>
            <td>
              <% if (variant.image || product?.image) { %>
                <img src="<%= variant.image || product.image %>" alt="<%= product.name %>" style="max-width: 100px;">
              <% } else { %>
                Kh√¥ng c√≥ ·∫£nh
              <% } %>
            </td>
            <td><%= product?.name || 'N/A' %></td>
            <td><%= variant.size || 'N/A' %> / <%= variant.color || 'N/A' %></td>
            <td>
              <button class="btn btn-primary btn-sm" onclick="openProductModal('cart', '<%= user._id %>')">üõí Th√™m v√†o gi·ªè</button>
              <button class="btn btn-danger btn-sm" onclick="openProductModal('favorites', '<%= user._id %>')">‚ù§Ô∏è Th√™m l·∫°i y√™u th√≠ch</button>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  <% } else { %>
    <p>Ch∆∞a c√≥ s·∫£n ph·∫©m y√™u th√≠ch.</p>
  <% } %>

  <!-- Bootstrap Modal for Product Selection -->
  <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productModalLabel">Ch·ªçn s·∫£n ph·∫©m</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <% if (products && products.length > 0) { %>
            <select id="productSelect" class="form-select mb-3">
              <option value="">Ch·ªçn s·∫£n ph·∫©m</option>
              <% products.forEach((product) => { %>
                <option value="<%= product._id %>" data-variants='<%= JSON.stringify(product.variants || []) %>'>
                  <%= product.name %>
                </option>
              <% }); %>
            </select>
          <% } else { %>
            <p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ hi·ªÉn th·ªã.</p>
          <% } %>
          <select id="variantSelect" class="form-select mb-3" disabled>
            <option value="">Ch·ªçn size/m√†u</option>
          </select>
          <div id="productImage" class="mb-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" id="confirmAddButton" disabled>X√°c nh·∫≠n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS and Custom Script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentAction = '';
    let currentUserId = '';
    const products =  products ? JSON.stringify(products) : '[]'

    // Debug: Log products to verify data
    console.log('Products data:', products);

    function openProductModal(action, userId) {
      currentAction = action;
      currentUserId = userId;
      document.getElementById('productModalLabel').textContent = action === 'cart' ? 'Th√™m v√†o gi·ªè h√†ng' : 'Th√™m v√†o y√™u th√≠ch';
      document.getElementById('productSelect').value = '';
      document.getElementById('variantSelect').innerHTML = '<option value="">Ch·ªçn size/m√†u</option>';
      document.getElementById('variantSelect').disabled = true;
      document.getElementById('confirmAddButton').disabled = true;
      document.getElementById('productImage').innerHTML = '';
      new bootstrap.Modal(document.getElementById('productModal')).show();
    }

    document.getElementById('productSelect').addEventListener('change', function () {
      const productId = this.value;
      let variants = [];
      try {
        variants = JSON.parse(this.options[this.selectedIndex].dataset.variants || '[]');
        console.log('Selected product ID:', productId, 'Variants:', variants);
      } catch (err) {
        console.error('Error parsing variants:', err);
        variants = [];
      }
      const variantSelect = document.getElementById('variantSelect');
      const productImage = document.getElementById('productImage');
      variantSelect.innerHTML = '<option value="">Ch·ªçn size/m√†u</option>';
      variantSelect.disabled = variants.length === 0;

      if (variants.length > 0) {
        variants.forEach((variant, index) => {
          if (variant && (variant.size || variant.color)) {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${variant.size || 'Kh√¥ng c√≥ size'} / ${variant.color || 'Kh√¥ng c√≥ m√†u'}`;
            variantSelect.appendChild(option);
          }
        });
        console.log('Variant options added:', variantSelect.options.length - 1);
      } else {
        console.log('No variants available for this product');
      }

      const product = products.find(p => p._id === productId);
      productImage.innerHTML = product?.image ? `<img src="${product.image}" alt="${product.name || 'S·∫£n ph·∫©m'}" style="max-width: 100px;">` : 'Kh√¥ng c√≥ ·∫£nh';
      document.getElementById('confirmAddButton').disabled = !productId;
    });

    document.getElementById('variantSelect').addEventListener('change', function () {
      const productId = document.getElementById('productSelect').value;
      const variantIndex = this.value;
      const product = products.find(p => p._id === productId);
      const variant = product?.variants?.[variantIndex];
      const productImage = document.getElementById('productImage');
      productImage.innerHTML = variant?.image ? `<img src="${variant.image}" alt="${variant.size || 'N/A'}/${variant.color || 'N/A'}" style="max-width: 100px;">` : product?.image ? `<img src="${product.image}" alt="${product.name || 'S·∫£n ph·∫©m'}" style="max-width: 100px;">` : 'Kh√¥ng c√≥ ·∫£nh';
      document.getElementById('confirmAddButton').disabled = !productId;
      console.log('Selected variant index:', variantIndex, 'Variant data:', variant);
    });

    document.getElementById('confirmAddButton').addEventListener('click', async function () {
      const productId = document.getElementById('productSelect').value;
      const variantIndex = document.getElementById('variantSelect').value || '0';
      if (!productId) return alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m');

      const url = currentAction === 'cart' ? '/accounts/cart/add-by-id' : '/accounts/favorites/add-by-id';
      const body = {
        userId: currentUserId,
        productId,
        variantIndex,
        ...(currentAction === 'cart' && { quantity: 1 }),
      };

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const result = await response.json();
        if (result.success) {
          alert(result.message);
          bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
          window.location.reload();
        } else {
          alert('L·ªói: ' + result.message);
        }
      } catch (err) {
        alert('L·ªói khi g·ª≠i y√™u c·∫ßu: ' + err.message);
      }
    });
  </script>
</body>
</html>